<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Icewater&#39;s Blog</title>
  <meta name="author" content="lfq7413">
  
  <meta name="description" content="description">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Icewater&#39;s Blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Icewater&#39;s Blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Icewater&#39;s Blog</a></h1>
  <h2><a href="/">subtitle</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">首页</a></li>
    
      <li><a href="/archives">归档</a></li>
    
      <li><a href="https://github.com/lfq7413">GitHub</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-04-24T13:03:14.000Z"><a href="/2015/04/24/Material-Design-实践：将导航抽屉显示到-ActionBar-与-statusbar-之间/">2015-04-24</a></time>
      
      
  
    <h1 class="title"><a href="/2015/04/24/Material-Design-实践：将导航抽屉显示到-ActionBar-与-statusbar-之间/">Material Design 实践：将导航抽屉显示到 ActionBar 与 statusbar 之间</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="0x00">0x00</h2><p>在 Material Design 中，导航抽屉要显示到状态栏以下，ActionBar 或者 ToolBar 以上，状态栏呈现半透明状，这种效果在最新的 Google 应用中大量应用。实际的显示效果如下图所示：</p>
<p><img src="http://ww2.sinaimg.cn/large/6c02de7dgw1ergyi22gc2j20a00a0t9h.jpg" alt=""></p>
<p>在 Eclipse 下使用 ADT 生成的导航抽屉应用模板中，还是早先的 Android Design ，导航抽屉会显示在状态栏与 ActionBar 之下。本文将在该模板的基础上改进，参考了 <a href="http://stackoverflow.com/questions/26440879/how-do-i-use-drawerlayout-to-display-over-the-actionbar-toolbar-and-under-the-st/26440880" target="_blank" rel="external">stackoverflow</a> 上得票最高的答案。</p>
<blockquote>
<p>新建空项目，按照以下步骤也是可以做到的。</p>
</blockquote>
<h2 id="0x01_原理">0x01 原理</h2><p>要实现上述的效果，需要做到以下几点：</p>
<ol>
<li>状态栏需要变成灰色的半透明状</li>
<li>导航抽屉要延伸到状态栏以下</li>
<li>导航抽屉要覆盖在 ActionBar 上面</li>
<li>整体页面要延伸到状态栏以下</li>
<li>要能设置半透明状态后面的背景颜色</li>
</ol>
<h2 id="0x02_操作">0x02 操作</h2><ol>
<li>使用 Toolbar 来替代默认的 ActionBar ，这样可以使其嵌入到页面的视图层级中，导航抽屉就可以覆盖到 ActionBar 上</li>
<li>设置页面根布局 DrawerLayout 的 fitsSystemWindows 为 true ，则可使其延伸到状态栏下面</li>
<li>设置导航抽屉布局的 fitsSystemWindows 为 true ，使其延伸到状态栏下面</li>
<li>在主题中设置状态栏颜色 statusBarColor 为半透明</li>
<li>在主题中设置 windowDrawsSystemBarBackgrounds 为 true ，之后可在代码中设置状态栏的背景</li>
</ol>
<blockquote>
<p>我们要用到最新的 Appcompat 兼容包。</p>
</blockquote>
<h2 id="0x03_布局文件">0x03 布局文件</h2><p>布局文件及注释参考如下：</p>
<pre><code><span class="comment">&lt;!-- 注意设置 fitSystemWindows --&gt;</span>
<span class="tag">&lt;<span class="title">android.support.v4.widget.DrawerLayout</span>
    <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span>
    <span class="attribute">android:id</span>=<span class="value">"@+id/my_drawer_layout"</span>
    <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span>
    <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span>
    <span class="attribute">android:fitsSystemWindows</span>=<span class="value">"true"</span>&gt;</span>

    <span class="tag">&lt;<span class="title">LinearLayout</span>
        <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span>
        <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span>
        <span class="attribute">android:orientation</span>=<span class="value">"vertical"</span>&gt;</span>

        <span class="comment">&lt;!-- 这里使用 Toolbar ，抽屉可显示到 ActionBar 之上 --&gt;</span>
        <span class="tag">&lt;<span class="title">android.support.v7.widget.Toolbar</span>  
            <span class="attribute">android:id</span>=<span class="value">"@+id/my_awesome_toolbar"</span>
            <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span>
                <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span>
            <span class="attribute">android:minHeight</span>=<span class="value">"?attr/actionBarSize"</span>
            <span class="attribute">android:background</span>=<span class="value">"?attr/colorPrimary"</span> /&gt;</span>

    <span class="tag">&lt;/<span class="title">LinearLayout</span>&gt;</span>

    <span class="comment">&lt;!-- 导航抽屉，这里可以使任何 view, 设置 fitSystemWindows=true
         其将会延伸到 status bar 之下 --&gt;</span>
    <span class="tag">&lt;<span class="title">LinearLayout</span>
        <span class="attribute">android:layout_width</span>=<span class="value">"304dp"</span>
        <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span>
        <span class="attribute">android:layout_gravity</span>=<span class="value">"left|start"</span>
        <span class="attribute">android:fitsSystemWindows</span>=<span class="value">"true"</span>&gt;</span>

    <span class="tag">&lt;/<span class="title">LinearLayout</span>&gt;</span>

<span class="tag">&lt;/<span class="title">android.support.v4.widget.DrawerLayout</span>&gt;</span>
</code></pre><h2 id="0x04_Activity/Fragment_中的代码">0x04 Activity/Fragment 中的代码</h2><p>在 Activity/Fragment 中指定 toolbar 来作为 ActionBar ，并在根布局上设置状态栏后面的背景颜色：</p>
<pre><code><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundled savedInstanceState)</span> </span>{
    <span class="keyword">super</span>.onCreate(savedInstanceState);

    <span class="comment">// 将 Toolbar 设置为 ActionBar</span>
    Toolbar toolbar = (Toolbar) findViewById(R.id.my_awesome_toolbar);
    setSupportActionBar(toolbar);

    <span class="comment">// 设置状态栏背景颜色，只会在 Lollipop 上生效</span>
    DrawerLayout drawerLayout = (DrawerLayout) findViewById(R.id.my_drawer_layout);
    drawerLayout.setStatusBarBackgroundColor(<span class="number">0xFFF44336</span>);
}
</code></pre><h2 id="0x05_修改主题">0x05 修改主题</h2><p>因为以下几个属性只在v21之后的系统版本中存在，所以需要修改 values-v21/themes.xml 这个主题文件：</p>
<pre><code>&lt;style name=<span class="string">"Theme.MyApp"</span> parent=<span class="string">"Theme.AppCompat.Light.NoActionBar"</span>&gt;
    &lt;item name=<span class="string">"android:windowDrawsSystemBarBackgrounds"</span>&gt;true&lt;/item&gt;
    &lt;item name=<span class="string">"android:statusBarColor"</span>&gt;<span class="hexcolor">#100000</span>00&lt;/item&gt;
&lt;/style&gt;
</code></pre><ul>
<li>父主题需要选择 NoActionBar 这一类的，因为我们已经使用 ToolBar 作为 ActionBar 了</li>
<li>设置 windowDrawsSystemBarBackgrounds=true 允许修改背景</li>
<li>设置 statusBarColor 标题栏颜色为半透明，透明值可自定义</li>
<li>不需要再设置 windowTranslucentStatus 属性，此系统定义的半透明不可控，使用 statusBarColor 即可</li>
</ul>
<h2 id="0x06_如果抽屉视图为_fragment">0x06 如果抽屉视图为 fragment</h2><p>如果使用 fragment 作为抽屉视图，那么需要在 onCreateView 中再次设置 fitsSystemWindows </p>
<pre><code><span class="annotation">@Override</span>
<span class="keyword">public</span> <span class="function">View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, 
                 ViewGroup container,
                 Bundle savedInstanceState)</span> </span>{
    View mDrawerListView = inflater.inflate(
    R.layout.fragment_navigation_drawer, container, <span class="keyword">false</span>);
    mDrawerListView.setFitsSystemWindows(<span class="keyword">true</span>);
    <span class="keyword">return</span> mDrawerListView;
}
</code></pre><h2 id="0x07_总结">0x07 总结</h2><p>通过以上几步，即可实现本文开头提到的效果。但是有一点不足：抽屉中的元素均排在状态栏下面。可设置 layout_marginTop 为负值，大小为状态栏的高度，使元素与状态栏重叠显示。在<a href="http://soloho.cc/blog/how-do-i-use-drawerlayout-to-display-over-the-actionbar-or-toolbar-and-under-the-status-bar?utm_source=tuicool" target="_blank" rel="external">这篇文章</a>中使用到了 <a href="http://stackoverflow.com/questions/26440879/how-do-i-use-drawerlayout-to-display-over-the-actionbar-toolbar-and-under-the-st/26440880" target="_blank" rel="external">stackoverflow</a> 上得票第二高答案中的方法，使用开源库来自动计算状态栏高度，并设置位移。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-04-20T05:23:34.000Z"><a href="/2015/04/20/Android-蓝牙-spp-开发汇总/">2015-04-20</a></time>
      
      
  
    <h1 class="title"><a href="/2015/04/20/Android-蓝牙-spp-开发汇总/">Android 蓝牙 spp 开发汇总</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="0x00">0x00</h2><p>本文记录蓝牙 spp 开发的流程及遇到的问题。包括设备扫描、配对、连接、数据交互</p>
<blockquote>
<p><strong>蓝牙权限：</strong></p>
</blockquote>
<pre><code>&lt;uses-permission android:<span class="property">name</span>=<span class="string">"android.permission.BLUETOOTH"</span> /&gt;
&lt;uses-permission android:<span class="property">name</span>=<span class="string">"android.permission.BLUETOOTH_ADMIN"</span> /&gt;
</code></pre><h2 id="0x01_设备扫描">0x01 设备扫描</h2><ul>
<li><p>获取蓝牙适配器</p>
<pre><code>BluetoothAdapter.getDefaultAdapter<span class="comment">()</span>;
</code></pre></li>
<li><p>检测蓝牙是否打开</p>
<pre><code>BluetoothAdapter.<span class="function"><span class="title">isEnabled</span><span class="params">()</span></span>
</code></pre></li>
<li><p>打开蓝牙设置界面</p>
<pre><code>Intent intent = <span class="keyword">new</span> Intent(BluetoothAdapter.ACTION_REQUEST_ENABLE);
startActivityForResult(intent, Activity.REQUEST_ENABLE);

<span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">onActivityResult</span><span class="params">(<span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode, Intent data)</span> </span>{
    <span class="keyword">if</span> (requestCode == REQUEST_ENABLE) {
        <span class="keyword">if</span> (resultCode == RESULT_OK) {
            <span class="comment">//TODO 接收蓝牙打开的消息</span>
        } 
    }
}
</code></pre></li>
<li><p>开启扫描</p>
<pre><code>BluetoothAdapter.startDiscovery<span class="comment">()</span>;
</code></pre></li>
<li><p>接收扫描结果</p>
<pre><code>IntentFilter intentFilter <span class="subst">=</span> <span class="literal">new</span> IntentFilter();
intentFilter<span class="built_in">.</span>addAction(BluetoothDevice<span class="built_in">.</span>ACTION_FOUND);
intentFilter<span class="built_in">.</span>addAction(BluetoothAdapter<span class="built_in">.</span>ACTION_DISCOVERY_FINISHED);
registerReceiver(<span class="literal">new</span> ScanBluetoothReceiver(), intentFilter);

<span class="keyword">public</span> <span class="literal">void</span> onReceive(Context context, final Intent intent) {
    <span class="built_in">String</span> action <span class="subst">=</span> intent<span class="built_in">.</span>getAction();
    BluetoothDevice bluetoothDevice <span class="subst">=</span> intent<span class="built_in">.</span>getParcelableExtra(BluetoothDevice<span class="built_in">.</span>EXTRA_DEVICE);
    <span class="keyword">if</span> (action<span class="built_in">.</span><span class="keyword">equals</span>(BluetoothDevice<span class="built_in">.</span>ACTION_FOUND)) {
        <span class="comment">//TODO 扫描到设备 bluetoothDevice</span>
    } <span class="keyword">else</span> <span class="keyword">if</span> (action<span class="built_in">.</span><span class="keyword">equals</span>(BluetoothAdapter<span class="built_in">.</span>ACTION_DISCOVERY_FINISHED)) {
        <span class="comment">//TODO 扫描结束</span>
        <span class="comment">//TODO 取消注册该接收器 unregisterReceiver(this);</span>
    } 
}
</code></pre></li>
</ul>
<h2 id="0x02_配对">0x02 配对</h2><ul>
<li><p>在与设备进行交互前停止设备扫描，设备扫描将影响设备的连接速度</p>
<pre><code><span class="type">BluetoothAdapter</span>.cancelDiscovery<span class="literal">()</span>;
</code></pre></li>
<li><p>设备配对</p>
<pre><code><span class="keyword">if</span> (<span class="type">BluetoothDevice</span>.getBondState<span class="literal">()</span> != <span class="type">BluetoothDevice</span>.<span class="type">BOND_BONDED</span>) {
    <span class="type">BluetoothDevice</span>.createBond<span class="literal">()</span>;
}
</code></pre></li>
<li><p>接受设备配对结果</p>
<pre><code>IntentFilter intentFilter = <span class="keyword">new</span> IntentFilter();
intentFilter.addAction(BluetoothDevice.ACTION_BOND_STATE_CHANGED);
registerReceiver(<span class="keyword">new</span> PairStateChangeReceiver(), intentFilter);

<span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>{
    <span class="keyword">if</span> (intent.getAction().equals(BluetoothDevice.ACTION_BOND_STATE_CHANGED)) {
        n++;
        device = BluetoothAdapter.getDefaultAdapter().getRemoteDevice(device.getAddress());
        <span class="keyword">if</span>(device.getBondState() != BluetoothDevice.BOND_BONDED){
            <span class="keyword">if</span>(n&gt;<span class="number">1</span>){
                n = <span class="number">0</span>;
                <span class="comment">//TODO 一般会接收到两次配对状态改变的广播，</span>
                <span class="comment">//TODO 当失败两次时则表示配对失败。</span>
            }
            <span class="keyword">return</span>;
        }
        <span class="comment">//TODO 配对成功之后可选择继续连接设备</span>
        <span class="comment">//TODO 配对成功之后取消注册 unregisterReceiver(this);</span>
    }
}
</code></pre></li>
</ul>
<h2 id="0x03_连接">0x03 连接</h2><ul>
<li><p>设备连接，使用通用的 SPP UUID 。</p>
<pre><code>BluetoothSocket <span class="variable">temp =</span> <span class="constant">null</span>; //TODO 使用中间变量赋值
BluetoothSocket <span class="variable">mSocket =</span> <span class="constant">null</span>;
String <span class="variable">uuid =</span> <span class="string">"00001101-0000-1000-8000-00805F9B34FB"</span>;
UUID <span class="variable">mUUID =</span> UUID.fromString(uuid);
<span class="variable">temp =</span> device.createInsecureRfcommSocketToServiceRecord(mUUID);
<span class="variable">mSocket =</span> temp;
mSocket.connect();
</code></pre></li>
</ul>
<h2 id="0x04_数据交互">0x04 数据交互</h2><ul>
<li><p>写入数据</p>
<pre><code>BufferedOutputStream <span class="keyword">out</span> = <span class="keyword">new</span> BufferedOutputStream(connection.getOutputStream());
<span class="keyword">out</span>.<span class="keyword">write</span>(data);
<span class="keyword">out</span>.flush();
</code></pre></li>
<li><p>读取数据</p>
<pre><code><span class="type">InputStream</span> input = connection.getInputStream<span class="literal">()</span>;
<span class="built_in">int</span> i;
<span class="keyword">if</span>(input.available<span class="literal">()</span> != <span class="number">0</span>){
    i = input.read<span class="literal">()</span>;
}
</code></pre></li>
</ul>
<h2 id="0x05_总结">0x05 总结</h2><p><strong>需要注意的问题有以下几点：</strong></p>
<ul>
<li>连接设备前务必关闭设备扫描，设备发现消耗很大，会影响连接速度；</li>
<li>配对时，会立即发出状态改变广播，配对结束会再次发送；</li>
<li>在 SPP 开发时，使用通用的 UUID ；</li>
<li>在读取数据时可配合使用 <code>input.available()</code> 达到设置超时的目的。</li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-03-14T09:26:12.000Z"><a href="/2015/03/14/hello-world/">2015-03-14</a></time>
      
      
  
    <h1 class="title"><a href="/2015/03/14/hello-world/">Hello</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="Hello_world!">Hello world!</h1><p><img src="http://ww1.sinaimg.cn/large/6c02de7djw1eq5mcc1bpuj21kw15iwlw.jpg" alt=""></p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





<nav id="pagination">
  
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright">
  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/Android/">Android</a><small>2</small></li>
  
    <li><a href="/categories/other/">other</a><small>1</small></li>
  
  </ul>
</div>


  

  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2015/04/24/Material-Design-实践：将导航抽屉显示到-ActionBar-与-statusbar-之间/">Material Design 实践：将导航抽屉显示到 ActionBar 与 statusbar 之间</a>
      </li>
    
      <li>
        <a href="/2015/04/20/Android-蓝牙-spp-开发汇总/">Android 蓝牙 spp 开发汇总</a>
      </li>
    
      <li>
        <a href="/2015/03/14/hello-world/">Hello</a>
      </li>
    
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015 lfq7413
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




</body>
</html>